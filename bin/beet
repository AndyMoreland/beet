#!/usr/bin/env ruby
 
require 'rubygems'
require 'thor'
require 'ruby-debug'
$:.unshift(File.dirname(__FILE__) + '/../lib')
require 'beet'
 
class BeetRunner < Thor
  default_task :help

  map "-g" => :generate
  map "-j" => :just_recipe
  map "-h" => :help
  map "-v" => :version
  map "-l" => :list
  map "--list" => :list

  desc 'generate [app_name]', "the main app generate method"
  method_options :recipes => :optional, :gems => :optional
  def generate(app_name, type=:rails)
    case type
    when :rails
      puts "Generating rails project #{app_name}..."
      system("rails #{app_name}")
      executor = Beet::Executor.new(app_name, options)
      executor.start
    else
      puts "type not recognized!"
    end
  end

  desc 'just_recipe', "when you just need a recipe"
  method_options :recipes => :optional, :gems => :optional
  def just_recipe(app_name='.')
    executor = Beet::Executor.new(app_name, options)
    executor.start
  end

  desc 'list', "list what recipes beet knows about"
  def list
    paths = [] 
    paths << File.dirname(__FILE__) + '/../lib/beet/recipes/**/*.rb'
    paths << ENV['BEET_RECIPES_DIR'] if ENV['BEET_RECIPES_DIR']
    recipes = paths.map do |path|
      Dir.glob(path)
    end.flatten.compact
    pp recipes
  end

  desc 'version', "the current version of beet"
  def version
    version_file = File.dirname(__FILE__) + '/../VERSION'
    if File.exists?(version_file) and version = File.read(version_file)
      puts "Beet version: #{version}"
    end
  end

  desc 'help', 'help output'
  def help
    puts %{
Usage: #{$0} /path/to/your/app [options]

Options:
    -g, --generate                   Run the generate command to build a project

Beet Info:
    -v, --version                    Show the Beet version number and quit.
    -l, --list                       Show the various recipes known to Beet and quit.
    -h, --help                       Show this help message and quit.

General Options:

Description:
  Beet is used to quickly generate applications.

Example:
    beet generate example_app --recipes="rails/authlogic, rails/clean_files, rails/git"
    
    Same thing but shorter:

    beet -g example_app -t=rails/authlogic,rails/clean_files,rails/git
} 
  end
end
BeetRunner.start
